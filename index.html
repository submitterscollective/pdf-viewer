<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF Viewer</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:rgba(255,255,255,.10);
      --panelBorder:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --btn:rgba(255,255,255,.10);
      --btnHover:rgba(255,255,255,.16);
      --btnBorder:rgba(255,255,255,.18);
      --bad:#ff5f5f;
      --ok:#4dffa8;
      --warn:#ffd44d;
    }
    html,body{height:100%;margin:0;background:var(--bg);}

    #bar{
      position:fixed; top:12px; left:12px; right:12px; z-index:10;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px; border-radius:14px;
      background:var(--panel);
      border:1px solid var(--panelBorder);
      backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      color:var(--text);
      font:600 13px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    #bar .left, #bar .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #title{
      max-width:38vw;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      color:var(--muted);
      font-weight:800;
    }

    button, a.btn{
      border:1px solid var(--btnBorder);
      background:var(--btn);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      font:800 12px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      cursor:pointer;
      transition:transform .12s ease, background .12s ease;
      text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center;
      user-select:none;
    }
    button:hover, a.btn:hover{ transform:translateY(-1px); background:var(--btnHover); }
    button:active, a.btn:active{ transform:translateY(0); }

    input[type="range"]{ width:180px; }

    #wrap{
      position:fixed; inset:0;
      padding-top:66px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      cursor:grab;
    }
    #wrap:active{ cursor:grabbing; }
    #stage{ display:flex; justify-content:center; padding:18px 14px 88px; }
    canvas{
      border-radius:14px;
      box-shadow:0 16px 50px rgba(0,0,0,.55);
      background:#fff;
    }

    #hint{
      position:fixed; bottom:12px; left:12px; right:12px; z-index:10;
      color:var(--muted);
      font:600 12px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      text-align:center;
      pointer-events:none;
    }

    #errorBox{
      position:fixed;
      left:12px; right:12px;
      bottom:48px;
      z-index:11;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color:var(--text);
      font:600 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      display:none;
      white-space:pre-wrap;
      word-break:break-word;
    }
    #errorBox b{ color:var(--warn); }

    @media (max-width:560px){
      input[type="range"]{ width:120px; }
      #title{ max-width:60vw; }
      #hint{ display:none; }
    }
  </style>
</head>
<body>

  <div id="bar">
    <div class="left">
      <button id="prev" title="Previous page">◀</button>
      <button id="next" title="Next page">▶</button>
      <span id="page">Page —</span>
      <span id="title">PDF</span>
    </div>

    <div class="right">
      <button id="zoomOut" title="Zoom out">−</button>
      <input id="zoom" type="range" min="50" max="250" value="120" />
      <button id="zoomIn" title="Zoom in">+</button>
      <span id="zoomLabel">120%</span>
      <a id="openPdf" class="btn" target="_blank" rel="noopener">Open PDF</a>
      <button id="diag" title="Show diagnostics">Diag</button>
    </div>
  </div>

  <div id="wrap">
    <div id="stage"><canvas id="c"></canvas></div>
  </div>

  <div id="hint">Loading…</div>
  <div id="errorBox"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>
  <script>
    // ====== CHANGE THESE IF YOU WANT ======
    const PDF_TITLE = "Chapter 7";
    const CANDIDATES = ["./ch7.pdf", "./ch7", "./ch7.PDF"]; // tries in order

    // Worker
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";

    // Elements
    const wrap = document.getElementById("wrap");
    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d", { alpha:false });

    const elTitle = document.getElementById("title");
    const elPage = document.getElementById("page");
    const elZoom = document.getElementById("zoom");
    const elZoomLabel = document.getElementById("zoomLabel");
    const elOpen = document.getElementById("openPdf");
    const hint = document.getElementById("hint");
    const errorBox = document.getElementById("errorBox");
    const diagBtn = document.getElementById("diag");

    elTitle.textContent = PDF_TITLE;

    let diagOpen = false;
    diagBtn.onclick = () => {
      diagOpen = !diagOpen;
      errorBox.style.display = diagOpen ? "block" : "none";
    };
    function status(msg){ hint.textContent = msg; }
    function showErr(msg){
      errorBox.textContent = msg;
      errorBox.style.display = "block";
      diagOpen = true;
    }

    async function exists(url){
      // Use GET (HEAD can be flaky on some hosts)
      const res = await fetch(url, { method:"GET", cache:"no-store" });
      const ct = (res.headers.get("content-type")||"").toLowerCase();
      return { ok: res.ok, status: res.status, statusText: res.statusText, contentType: ct, url };
    }

    async function pickPdfUrl(){
      let report = "PDF URL probe:\n";
      for (const rel of CANDIDATES){
        const u = new URL(rel, location.href).toString();
        const r = await exists(u);
        report += `- ${u}\n  -> ${r.ok ? "OK" : "FAIL"} (${r.status} ${r.statusText}) ct=${r.contentType||"(none)"}\n`;
        if (r.ok) return { url: u, report };
      }
      return { url: null, report };
    }

    // Viewer state
    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1.2;
    let rendering = false;
    let queued = false;

    async function render(){
      if (!pdfDoc || rendering){ queued = true; return; }
      rendering = true;

      const page = await pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({ scale });

      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(viewport.width * dpr);
      canvas.height = Math.floor(viewport.height * dpr);
      canvas.style.width = viewport.width + "px";
      canvas.style.height = viewport.height + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      await page.render({ canvasContext: ctx, viewport }).promise;

      elPage.textContent = `Page ${pageNum} / ${pdfDoc.numPages}`;
      elZoomLabel.textContent = `${Math.round(scale * 100)}%`;
      elZoom.value = Math.round(scale * 100);

      rendering = false;
      if (queued){ queued = false; render(); }
    }

    function setScale(next){
      scale = Math.max(0.5, Math.min(2.5, next));
      render();
    }

    // Controls
    document.getElementById("prev").onclick = () => {
      if (!pdfDoc || pageNum <= 1) return;
      pageNum--; render();
    };
    document.getElementById("next").onclick = () => {
      if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
      pageNum++; render();
    };
    document.getElementById("zoomIn").onclick = () => setScale(scale + 0.12);
    document.getElementById("zoomOut").onclick = () => setScale(scale - 0.12);
    elZoom.oninput = () => setScale(Number(elZoom.value) / 100);

    // Ctrl/⌘ + wheel zoom
    wrap.addEventListener("wheel", (e) => {
      if (!(e.ctrlKey || e.metaKey)) return;
      e.preventDefault();
      const dir = Math.sign(e.deltaY);
      setScale(scale + (dir > 0 ? -0.08 : 0.08));
    }, { passive:false });

    // Boot
    (async () => {
      try{
        status("Finding PDF…");
        const picked = await pickPdfUrl();

        if (!picked.url){
          status("PDF not found. Click Diag.");
          showErr(picked.report + "\nFix: upload the PDF to this repo and name it exactly ch7.pdf (or change CANDIDATES).");
          return;
        }

        // set Open PDF link to the real working file
        elOpen.href = picked.url;

        status("Loading PDF…");
        const task = pdfjsLib.getDocument({ url: picked.url, withCredentials:false });
        pdfDoc = await task.promise;

        status("Ready. Ctrl/⌘ + wheel to zoom.");
        await render();
      }catch(err){
        console.error(err);
        status("Failed. Click Diag.");
        showErr("Viewer error:\n" + (err?.message || String(err)));
      }
    })();
  </script>
</body>
</html>
