<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>
<script>
  // ====== CONFIG ======
  // Put the PDF in the SAME repo folder as index.html and name it exactly: ch7.pdf
  // Then this relative path works:
  const PDF_URL = new URL("./ch7.pdf", window.location.href).toString();
  const PDF_TITLE = "Chapter 7";

  // ====== PDF.js worker ======
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";

  // ====== Elements ======
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const elPage = document.getElementById("page");
  const elZoom = document.getElementById("zoom");
  const elZoomLabel = document.getElementById("zoomLabel");
  const elTitle = document.getElementById("title");
  const elOpen = document.getElementById("openPdf");
  const wrap = document.getElementById("wrap");
  const hint = document.getElementById("hint");

  elTitle.textContent = PDF_TITLE;
  elOpen.href = PDF_URL;

  // ====== State ======
  let pdfDoc = null;
  let pageNum = 1;
  let scale = 1.2;
  let rendering = false;
  let queued = false;

  function showStatus(msg){
    hint.textContent = msg;
  }

  async function verifyPdfReachable(url){
    // This tells us immediately if the PDF is 404 / wrong path / blocked.
    // Uses a tiny range request; if the server refuses ranges, it still usually returns 200.
    const res = await fetch(url, { method: "GET" });
    if (!res.ok) throw new Error(`PDF fetch failed: ${res.status} ${res.statusText}`);
    const ct = (res.headers.get("content-type") || "").toLowerCase();
    // content-type might be application/pdf or octet-stream; both are ok
    if (!ct.includes("pdf") && !ct.includes("octet-stream")) {
      // Not fatal, but suspicious
      console.warn("Unexpected content-type:", ct);
    }
  }

  async function render(){
    if (!pdfDoc || rendering) { queued = true; return; }
    rendering = true;

    const page = await pdfDoc.getPage(pageNum);
    const viewport = page.getViewport({ scale });

    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(viewport.width * dpr);
    canvas.height = Math.floor(viewport.height * dpr);
    canvas.style.width = viewport.width + "px";
    canvas.style.height = viewport.height + "px";
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    await page.render({ canvasContext: ctx, viewport }).promise;

    elPage.textContent = `Page ${pageNum} / ${pdfDoc.numPages}`;
    elZoomLabel.textContent = `${Math.round(scale * 100)}%`;
    elZoom.value = Math.round(scale * 100);

    rendering = false;
    if (queued) { queued = false; render(); }
  }

  async function start(){
    try{
      showStatus("Loading PDF…");

      // 1) Confirm the URL resolves correctly (this catches 404 instantly)
      await verifyPdfReachable(PDF_URL);

      // 2) Load with PDF.js
      const loadingTask = pdfjsLib.getDocument({
        url: PDF_URL,
        withCredentials: false
      });

      pdfDoc = await loadingTask.promise;
      showStatus("Tip: Ctrl/⌘ + mouse wheel = smooth zoom. Trackpad pinch-to-zoom works in many browsers.");
      await render();
    }catch(err){
      console.error(err);
      showStatus(
        "PDF did not load. Most common cause: the file is not at /pdf-viewer/ch7.pdf (wrong name, missing .pdf, or wrong folder)."
      );
    }
  }

  start();

  // ====== Controls ======
  document.getElementById("prev").onclick = () => {
    if (!pdfDoc || pageNum <= 1) return;
    pageNum--; render();
  };
  document.getElementById("next").onclick = () => {
    if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
    pageNum++; render();
  };

  function setScale(next){
    scale = Math.max(0.5, Math.min(3.0, next));
    render();
  }
  document.getElementById("zoomIn").onclick = () => setScale(scale + 0.12);
  document.getElementById("zoomOut").onclick = () => setScale(scale - 0.12);
  elZoom.oninput = () => setScale(Number(elZoom.value) / 100);

  wrap.addEventListener("wheel", (e) => {
    if (!(e.ctrlKey || e.metaKey)) return;
    e.preventDefault();
    const direction = Math.sign(e.deltaY);
    setScale(scale + (direction > 0 ? -0.08 : 0.08));
  }, { passive:false });

  window.addEventListener("keydown", (e) => {
    if (!pdfDoc) return;
    if (e.key === "ArrowRight") { if (pageNum < pdfDoc.numPages) { pageNum++; render(); } }
    if (e.key === "ArrowLeft")  { if (pageNum > 1) { pageNum--; render(); } }
    if ((e.ctrlKey || e.metaKey) && (e.key === "+" || e.key === "=")) { e.preventDefault(); setScale(scale + 0.12); }
    if ((e.ctrlKey || e.metaKey) && e.key === "-") { e.preventDefault(); setScale(scale - 0.12); }
  });
</script>
