<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fast PDF Viewer</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:rgba(255,255,255,.10);
      --panelBorder:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --btn:rgba(255,255,255,.10);
      --btnHover:rgba(255,255,255,.16);
      --btnBorder:rgba(255,255,255,.18);
    }
    html,body{height:100%;margin:0;background:var(--bg);}

    #bar{
      position:fixed; top:12px; left:12px; right:12px; z-index:10;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px; border-radius:14px;
      background:var(--panel);
      border:1px solid var(--panelBorder);
      backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      color:var(--text);
      font:600 13px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    #bar .left, #bar .right{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    #title{
      max-width:38vw;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      color:var(--muted);
      font-weight:700;
    }

    button, a.btn {
      border:1px solid var(--btnBorder);
      background:var(--btn);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      font:700 12px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      cursor:pointer;
      transition:transform .12s ease, background .12s ease;
      text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center;
      user-select:none;
      will-change:transform;
    }
    button:hover, a.btn:hover { transform:translateY(-1px); background:var(--btnHover); }
    button:active, a.btn:active { transform:translateY(0); }

    input[type="range"]{ width:180px; }

    #wrap{
      position:fixed; inset:0;
      padding-top:66px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      cursor:grab;
    }
    #wrap:active{ cursor:grabbing; }

    #stage{
      display:flex; justify-content:center;
      padding:18px 14px 70px;
    }

    canvas{
      border-radius:14px;
      box-shadow:0 16px 50px rgba(0,0,0,.55);
      background:#fff;
      image-rendering:auto;
    }

    #hint{
      position:fixed; bottom:12px; left:12px; right:12px; z-index:10;
      color:var(--muted);
      font:500 12px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      text-align:center;
      pointer-events:none;
    }

    @media (max-width:560px){
      input[type="range"]{ width:120px; }
      #title{ max-width:60vw; }
      #hint{ display:none; }
    }
  </style>
</head>
<body>

  <div id="bar">
    <div class="left">
      <button id="prev" title="Previous page">◀</button>
      <button id="next" title="Next page">▶</button>
      <span id="page">Page —</span>
      <span id="title">Chapter 7</span>
    </div>

    <div class="right">
      <button id="zoomOut" title="Zoom out">−</button>
      <input id="zoom" type="range" min="50" max="250" value="120" />
      <button id="zoomIn" title="Zoom in">+</button>
      <span id="zoomLabel">120%</span>
      <a id="openPdf" class="btn" target="_blank" rel="noopener">Open PDF</a>
    </div>
  </div>

  <div id="wrap">
    <div id="stage"><canvas id="c"></canvas></div>
  </div>

  <div id="hint">Drag to pan/scroll. Ctrl/⌘ + wheel = zoom. (Fast preview while zooming, sharp render after.)</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>
  <script>
    // ========= CONFIG =========
    // Put this file in the SAME folder as index.html in the repo.
    const PDF_FILE = "./ch7.pdf";
    const TITLE = "Chapter 7";

    // ========= PDF.js worker =========
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";

    // ========= Elements =========
    const wrap = document.getElementById("wrap");
    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d", { alpha: false });

    const elTitle = document.getElementById("title");
    const elPage = document.getElementById("page");
    const elZoom = document.getElementById("zoom");
    const elZoomLabel = document.getElementById("zoomLabel");
    const elOpen = document.getElementById("openPdf");
    const hint = document.getElementById("hint");

    elTitle.textContent = TITLE;
    elOpen.href = PDF_FILE;

    // ========= State =========
    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1.2;

    // “Fast while interacting, sharp after”:
    let settleTimer = null;
    let isInteracting = false;

    // Render queue:
    let rendering = false;
    let rerenderRequested = false;

    function status(msg){ hint.textContent = msg; }

    async function fetchPdfBytes(url){
      // Same-origin (GitHub Pages) => fast + reliable.
      const res = await fetch(url, { cache: "force-cache" });
      if (!res.ok) throw new Error(`PDF fetch failed: ${res.status} ${res.statusText}`);
      return new Uint8Array(await res.arrayBuffer());
    }

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    async function render(quality){
      // quality: "fast" uses dpr=1; "sharp" uses devicePixelRatio
      if (!pdfDoc) return;

      if (rendering) { rerenderRequested = true; return; }
      rendering = true;

      try{
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale });

        const dpr = (quality === "sharp") ? (window.devicePixelRatio || 1) : 1;

        canvas.width = Math.floor(viewport.width * dpr);
        canvas.height = Math.floor(viewport.height * dpr);
        canvas.style.width = viewport.width + "px";
        canvas.style.height = viewport.height + "px";

        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        ctx.imageSmoothingEnabled = true;

        await page.render({ canvasContext: ctx, viewport }).promise;

        elPage.textContent = `Page ${pageNum} / ${pdfDoc.numPages}`;
        elZoomLabel.textContent = `${Math.round(scale * 100)}%`;
        elZoom.value = Math.round(scale * 100);
      } finally {
        rendering = false;
        if (rerenderRequested) {
          rerenderRequested = false;
          // If something queued up, render sharp (final state)
          render("sharp");
        }
      }
    }

    function requestFastThenSharp(){
      // Fast render immediately, then sharp render after user stops.
      isInteracting = true;
      render("fast");

      clearTimeout(settleTimer);
      settleTimer = setTimeout(() => {
        isInteracting = false;
        render("sharp");
      }, 140);
    }

    function setScale(next){
      scale = clamp(next, 0.5, 2.5);
      requestFastThenSharp();
    }

    async function start(){
      try{
        status("Loading PDF…");
        const data = await fetchPdfBytes(PDF_FILE);

        // Load from bytes (fast + avoids weird redirects/CORS entirely)
        const task = pdfjsLib.getDocument({ data, disableAutoFetch: true, disableStream: true });
        pdfDoc = await task.promise;

        status("Drag to pan/scroll. Ctrl/⌘ + wheel = zoom.");
        await render("sharp");
      }catch(err){
        console.error(err);
        status("PDF failed to load. Most common cause: ch7.pdf not found next to index.html (wrong name/case/path).");
      }
    }

    // ========= Controls =========
    document.getElementById("prev").onclick = () => {
      if (!pdfDoc || pageNum <= 1) return;
      pageNum--;
      requestFastThenSharp();
    };

    document.getElementById("next").onclick = () => {
      if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
      pageNum++;
      requestFastThenSharp();
    };

    document.getElementById("zoomIn").onclick = () => setScale(scale + 0.12);
    document.getElementById("zoomOut").onclick = () => setScale(scale - 0.12);
    elZoom.oninput = () => setScale(Number(elZoom.value) / 100);

    // Smooth zoom: Ctrl/⌘ + wheel (matches browser expectations)
    wrap.addEventListener("wheel", (e) => {
      if (!(e.ctrlKey || e.metaKey)) return;
      e.preventDefault();
      const dir = Math.sign(e.deltaY);
      setScale(scale + (dir > 0 ? -0.08 : 0.08));
    }, { passive:false });

    // Drag-to-pan (makes it feel “app-like”)
    let drag = { on:false, x:0, y:0, sx:0, sy:0 };
    wrap.addEventListener("pointerdown", (e) => {
      drag.on = true;
      drag.x = e.clientX; drag.y = e.clientY;
      drag.sx = wrap.scrollLeft; drag.sy = wrap.scrollTop;
      wrap.setPointerCapture(e.pointerId);
    });
    wrap.addEventListener("pointermove", (e) => {
      if (!drag.on) return;
      const dx = e.clientX - drag.x;
      const dy = e.clientY - drag.y;
      wrap.scrollLeft = drag.sx - dx;
      wrap.scrollTop = drag.sy - dy;
    });
    wrap.addEventListener("pointerup", () => { drag.on = false; });
    wrap.addEventListener("pointercancel", () => { drag.on = false; });

    // Keyboard
    window.addEventListener("keydown", (e) => {
      if (!pdfDoc) return;
      if (e.key === "ArrowRight") { if (pageNum < pdfDoc.numPages) { pageNum++; requestFastThenSharp(); } }
      if (e.key === "ArrowLeft")  { if (pageNum > 1) { pageNum--; requestFastThenSharp(); } }
      if ((e.ctrlKey || e.metaKey) && (e.key === "+" || e.key === "=")) { e.preventDefault(); setScale(scale + 0.12); }
      if ((e.ctrlKey || e.metaKey) && e.key === "-") { e.preventDefault(); setScale(scale - 0.12); }
    });

    // Keep it crisp on resize (re-fit current state)
    window.addEventListener("resize", () => {
      // Don’t spam: just render sharp once
      clearTimeout(settleTimer);
      settleTimer = setTimeout(() => render("sharp"), 120);
    });

    start();
  </script>
</body>
</html>
